"use strict";
(()=>{var g={INT:"integer",PERCENT:"percent"},x=class{constructor(t,s,e,o,a,l,h,u){this.xPos=t,this.yPos=s,this.width=e,this.height=o,this.name=a,this.displayString=a+": ",this.value=l,this.type=h,this.mouseOver=!1,this.promptModify=!1,this.active=!1,this.resetOnChange=u,Q.push(this),d.push(this),p.push(this),H.push(this)}draw(){i.strokeStyle=r.LGRAY,i.beginPath(),i.rect(this.xPos,this.yPos,this.width,this.height),i.stroke(),i.font=v,i.fillStyle=r.HEALTHY,i.fillText(this.displayString+this.value+(this.type===g.PERCENT?"%":""),this.xPos+this.width*.05,this.yPos+this.height*.8,this.width*.9),i.font=y}drawPromptBox(){i.beginPath(),i.rect(A,Y,M,_),i.fillStyle=r.BACKGROUND,i.fill(),i.beginPath(),i.rect(A,Y,M,_),i.strokeStyle=r.HEALTHY,i.stroke(),i.font=v,i.fillStyle=r.HEALTHY,i.fillText("Voer een nieuwe waarde in voor "+this.displayString,A+10,Y+15,M*.95),i.fillText("> "+b,A+10,Y+30,M*.95),i.font=y}modify(){this.active=!0,this.drawPromptBox()}clickHandler(){this.promptModify=!0,b=""}hoverHandler(){this.mouseOver=!0}mouseOutHandler(){this.mouseOver=!1}keyHandler(t){if(this.active)if(t>="0"&&t<="9"||t==".")b=b+t;else if(t=="Backspace")b=b.slice(0,b.length-1);else if(t=="Enter"){this.promptModify=!1,this.active=!1;let s;this.type==g.INT?s=parseInt(b):this.type==g.PERCENT&&(s=parseFloat(b)),this.value=s,this.resetOnChange==!0&&(C.value=L.RESTART)}else t=="Escape"&&(this.promptModify=!1,this.active=!1)}},Q=[],d=[],H=[],p=[],V=[],B=[],wt=new x(15,300,160,15,"Transmissiekans",10,g.PERCENT,!1),Et=new x(15,315,160,15,"Reiskans",5,g.PERCENT,!1),S=new x(15,330,160,15,"Begin infecties",3,g.INT,!1),xt=new x(15,345,160,15,"Herstelperiode",14,g.INT,!1),K=0,A=150,Y=75,M=300,_=45,tt,N,kt=5,Ht=5,T=new x(15,360,160,15,"Aantal huishoudens",20,g.INT,!0),c=[],Ct=0,et=100,st=100,it=50,ot=35,Rt=400,At=320,P=14,O=14,nt=0,Yt=0,Mt="myCanvas",w=document.getElementById(Mt),i=w.getContext("2d");i.imageSmoothingEnabled=!1;var at=w.offsetLeft,lt=w.offsetTop,Lt=n=>H.forEach(t=>t.keyHandler(n.key));w.addEventListener("click",Bt);w.addEventListener("mousemove",Nt);window.addEventListener("keydown",Lt);var Ot="14pt",rt='"Lucida Console", Monaco, monospace',y=Ot+" "+rt;i.font=y;var Ft="9pt",v=Ft+" "+rt,F=0,W=!1,G=30,Dt=Math.floor(1e3/G),zt=0,X=[S.value],U=[S.value],q=[S.value],b="",f=null,D,C,ht=!1,ct,r={BACKGROUND:"#000",HEALTHY:"#00FF00",SICK:"#FF0000",RECOVERED:"#FFFF00",LGRAY:"rgb(189, 255, 189)"},m={HEALTHY:"healthy",SICK:"sick",RECOVERED:"recovered"},R={SPEED1:60,SPEED2:30,SPEED3:15,SPEED4:8,SPEED5:2},$={RUN:"RUN",STOP:"STOP"},L={NORMAL:"NORMAL",RESTART:"RESTART"},ut=class{constructor(t,s,e,o){this.state=m.HEALTHY,this.xPos=t,this.yPos=s,this.community=e,this.position=o,this.daysSick=0,this.moving=!1,this.moveToX=0,this.moveToY=0,this.startX=0,this.startY=0,this.moveFrame=0,this.uniquePerson=zt++}draw(){switch(this.animate(),this.state){case m.HEALTHY:i.fillStyle=r.HEALTHY;break;case m.SICK:i.fillStyle=r.SICK;break;case m.RECOVERED:i.fillStyle=r.RECOVERED;break}i.fillText("Ï€",this.xPos,this.yPos,P-nt*2)}animate(){if(this.moving){let t=this.moveFrame/(f.value-1);this.xPos=this.startX*(1-t)+this.moveToX*t,this.yPos=this.startY*(1-t)+this.moveToY*t,this.moveFrame++}this.moveFrame>=f.value&&(this.moving=!1,this.moveFrame=0)}update(){this.state==m.SICK&&this.daysSick++,this.daysSick>xt.value&&(this.state=m.RECOVERED)}},mt=class{constructor(t,s,e){this.pickRandomPerson=()=>this.people[Math.floor(Math.random()*this.size)];this.countSick=()=>this.people.filter(t=>t.state==m.SICK).length;this.countSickToday=()=>this.people.filter(t=>t.state==m.SICK&&!t.daysSick).length;this.countTotalCases=()=>this.people.filter(t=>t.state!=m.HEALTHY).length;this.countMoving=()=>this.people.filter(t=>t.moving).length;this.update=()=>this.people.forEach(t=>t.update());let o=Math.ceil(Math.sqrt(t));this.uniqueCommunity=Ct++,this.height=o,this.width=o,this.xPos=s,this.yPos=e,this.size=t,this.people=Array.from({length:t});for(let a=0;a<t;a++){let l=k(this,a);this.people[a]=new ut(l[0],l[1],this,a)}}draw(){for(let a=0;a<this.size;a++)this.people[a].draw();let t=this.xPos-P,s=this.xPos+(this.width+1)*P,e=this.yPos-2*P,o=this.yPos+this.height*P;i.beginPath(),i.moveTo(t,e),i.lineTo(s,e),i.lineTo(s,o),i.lineTo(t,o),i.lineTo(t,e),i.strokeStyle=r.LGRAY,i.stroke()}spread(){let t=[];for(let s=0;s<this.size;s++)this.people[s].state==m.SICK&&(this.spreadHelper(this.getNorth(s),t),this.spreadHelper(this.getSouth(s),t),this.spreadHelper(this.getEast(s),t),this.spreadHelper(this.getWest(s),t));for(let s=0,e=t.length;s<e;s++){let o=t[s];this.people[o].state=m.SICK}}getNorth(t){return t-this.width<0?null:t-this.width}getSouth(t){let s=t+this.width;return s>this.size-1?null:s}getEast(t){return t%this.width==this.width-1?null:t+1}getWest(t){return t%this.width==0?null:t-1}spreadHelper(t,s){if(t==null)return;let e=this.people[t].state;Math.random()<=wt.value/100&&e==m.HEALTHY&&s.push(t)}},z=class{constructor(t,s,e,o,a,l){this.data=t,this.xPos=s,this.yPos=e,this.yHeight=o,this.xWidth=a,this.name=l,this.defaultBarSize=5}drawAxes(){let t=this.yPos+this.yHeight;i.beginPath(),i.moveTo(this.xPos,this.yPos),i.lineTo(this.xPos,t),i.lineTo(this.xPos+this.xWidth,t),i.strokeStyle=r.LGRAY,i.stroke()}drawName(){i.font=v,i.fillStyle=r.HEALTHY,i.fillText(this.name,this.xPos,this.yPos-10,this.xWidth),i.font=y}drawYTicks(){let t=this.yPos+this.yHeight;i.fillStyle=r.SICK,i.font=v;let s=Math.max(...this.data);if(s<this.yHeight){let e=this.generateTickMarks(this.yHeight);for(let o=0,a=e.length;o<a;o++)i.fillText(`${e[o]}`,this.xPos-2*P,t-e[o]+O*.5),i.beginPath(),i.moveTo(this.xPos,t-e[o]),i.lineTo(this.xPos-5,t-e[o]),i.stroke()}else{let e=this.generateTickMarks(s);for(let o=0,a=e.length;o<a;o++){let l=e[e.length-1];i.fillText(`${e[o]}`,this.xPos-2*P,t-e[o]/l*this.yHeight+O*.5),i.beginPath(),i.moveTo(this.xPos,t-e[o]/l*this.yHeight),i.lineTo(this.xPos-5,t-e[o]/l*this.yHeight),i.stroke()}}i.font=y}drawXTicks(){let t=this.yPos+this.yHeight;i.fillStyle=r.SICK,i.font=v;let s=this.defaultBarSize;s*this.data.length>this.xWidth&&(s=this.xWidth/this.data.length);let o=this.xWidth/s,a=this.generateTickMarks(o),l;for(l=0;l<a.length;l++)i.fillText(`${a[l]}`,this.xPos+a[l]*s,t+O);i.font=y}generateTickMarks(t){let s,e,o=1;for(;s=10**o,e=Math.ceil(t/s),!(e>=4&&e<=9||(s=2*10**o,e=Math.ceil(t/s),e>=4&&e<=9)||(s=5*10**o,e=Math.ceil(t/s),e>=4&&e<=9));)o++;let a=[],l;for(l=0;l<=e;l++)a.push(l*s);return a}drawData(){let t,s=this.defaultBarSize,e=this.yPos+this.yHeight;s*this.data.length>this.xWidth&&(s=this.xWidth/this.data.length);let a=Math.max(...this.data);if(i.fillStyle=r.SICK,a<this.yHeight)for(t=0;t<this.data.length;t++){let l=e-this.data[t],h=this.xPos+t*s;i.beginPath(),i.rect(h,l,s,this.data[t]),i.fill()}else for(t=0;t<this.data.length;t++){let l=this.data[t]/a*this.yHeight,h=e-l,u=this.xPos+t*s;i.beginPath(),i.rect(u,h,s,l),i.fill()}}draw(){this.drawName(),this.drawAxes(),this.drawYTicks(),this.drawXTicks(),this.drawData()}},ft=class{constructor(t,s,e,o,a,l,h,u,E){this.xPos=t,this.yPos=s,this.width=e,this.height=o,this.label=a,this.value=l,this.cluster=h,this.active=!1,this.blink=E,this.blinkStep=0,d.push(this),u==!0&&(this.active=!0)}clickHandler(){this.cluster.update(this.value),this.active=!0,this.blinkStep=0}draw(){let t,s;this.blink?this.active==!0&&this.blinkStep%(G*2)<G?(t=r.BACKGROUND,s=r.HEALTHY):(t=r.HEALTHY,s=r.BACKGROUND):this.active==!0?(t=r.BACKGROUND,s=r.HEALTHY):(t=r.HEALTHY,s=r.BACKGROUND),i.beginPath(),i.rect(this.xPos,this.yPos,this.width,this.height),i.fillStyle=s,i.fill(),i.beginPath(),i.rect(this.xPos,this.yPos,this.width,this.height),i.strokeStyle=r.LGRAY,i.stroke(),i.font=v,i.fillStyle=t,i.fillText(this.label,this.xPos+5,this.yPos+12,this.width*.9),i.font=y,this.blinkStep=this.blinkStep+1}},I=class{constructor(t,s,e,o,a){this.update=t=>this.insideValue=t;this.xPos=t,this.yPos=s,this.width=e,this.height=o,this.label=a,this.buttons=[],B.push(this),this.insideValue=null,this.value=null}addButton(t,s,e,o,a,l,h,u){let E=new ft(t,s,e,o,a,l,this,h,u);return this.buttons.push(E),h==!0&&(this.value=l,this.insideValue=l),E}draw(){i.beginPath(),i.rect(this.xPos,this.yPos-this.height,this.width,this.height),i.strokeStyle=r.LGRAY,i.stroke(),i.font=v,i.fillStyle=r.HEALTHY,i.fillText(this.label,this.xPos+this.width*.05,this.yPos-this.height*.2,this.width*.9),i.font=y;let t;for(t=0;t<this.buttons.length;t++)this.buttons[t].draw()}commit(){this.value=this.insideValue;let t;for(t=0;t<this.buttons.length;t++)this.value==this.buttons[t].value?this.buttons[t].active=!0:this.buttons[t].active=!1}};function pt(){It(),Vt(),Kt(),ht==!1&&(ht=!0,dt())}function Wt(){V=[],K=0,c=[],F=0,W=!1,X=[S.value],U=[S.value],q=[S.value],b="",pt()}function dt(){C.value==L.RESTART&&(ct.clickHandler(),Wt()),F%f.value==0&&Xt(),qt(),bt()==0&&(W=!0);let n;for(n=0;n<H.length;n++)if(H[n].promptModify==!0){H[n].modify(),j();return}if(F%f.value==0){let t;for(t=0;t<B.length;t++)B[t].commit();if(D.value==$.STOP){j();return}if(!W){for(t=0;t<c.length;t++)c[t].update(),c[t].spread();Gt(),Ut(),K++}}F++,j()}function j(){setTimeout(dt,Dt)}var $t=()=>V.forEach(n=>n.draw()),jt=()=>Q.forEach(n=>n.draw()),Zt=()=>B.forEach(n=>n.draw());function Gt(){X.push(bt()),U.push(Jt()),q.push(Qt())}function It(){let n=Math.ceil(Math.sqrt(T.value));N=n,tt=Math.ceil(T.value/n)}function Bt(n){let t=n.pageX-at,s=n.pageY-lt;for(let e=0,o=d.length;e<o;e++){let a=d[e].xPos,l=d[e].xPos+d[e].width,h=d[e].yPos,u=d[e].yPos+d[e].height;t>=a&&t<=l&&s>=h&&s<=u&&d[e].clickHandler()}}function Nt(n){let t=n.pageX-at,s=n.pageY-lt;for(let e=0,o=p.length;e<o;e++){let a=p[e].xPos,l=p[e].xPos+p[e].width,h=p[e].yPos,u=p[e].yPos+p[e].height;t>=a&&t<=l&&s>=h&&s<=u?p[e].hoverHandler():p[e].mouseOutHandler()}}var bt=()=>c.map(n=>n.countSick()).reduce((n,t)=>n+t),Jt=()=>c.map(n=>n.countSickToday()).reduce((n,t)=>n+t),Qt=()=>c.map(n=>n.countTotalCases()).reduce((n,t)=>n+t);function Xt(){for(let n=0,t=c.length;n<t;n++)for(let s=0,e=c[n].people.length;s<e;s++){let o=c[n].people[s],a=k(o.community,o.position);o.xPos=a[0],o.yPos=a[1]}}function k(n,t){let s=Math.floor(t/n.width),e=t%n.width,o=n.xPos+e*P+nt,a=n.yPos+s*O-Yt;return[o,a]}function Ut(){let t=_t()/2;for(let s=0;s<t;s++){let e=Z();e.moving=!0,e.moveFrame=0;let o=Z();for(;o.community==e.community;)o=Z();o.moving=!0,o.moveFrame=0;let a=k(e.community,e.position),l=k(o.community,o.position);e.startX=a[0],e.startY=a[1],o.startX=l[0],o.startY=l[1];let h=k(o.community,o.position),u=k(e.community,e.position);e.moveToX=h[0],e.moveToY=h[1],o.moveToX=u[0],o.moveToY=u[1];let E=e.community,yt=o.community,Pt=e.position,vt=o.position;E.people[Pt]=o,yt.people[vt]=e;let St=e.community,Tt=e.position;e.community=o.community,e.position=o.position,o.community=St,o.position=Tt}}var J,gt=()=>J=te().pickRandomPerson();function Z(){for(gt();J.moving;)gt();return J}function _t(){let n=ee(),t=0;for(let s=0;s<n;s++)Math.random()<=Et.value/100&&t++;return t%2&&t++,t}var ee=()=>c.map(n=>n.size).reduce((n,t)=>n+t),te=()=>c[Math.floor(Math.random()*T.value)];function se(){let n=2*ot+st*N,t=2*it+et*tt,s=Rt/n,e=At/t;return Math.min(s,e)}function qt(){ie(),i.fillStyle=r.HEALTHY,i.fillText(`${K}`,10,20),$t(),jt(),Zt();let n=se(),t=n,s=1/n;i.scale(t,t);for(let e=0;e<T.value;e++)c[e].draw();i.scale(s,s)}var ie=()=>i.clearRect(0,0,w.width,w.height);function Vt(){c=Array.from({length:T.value});for(let n=0,t=T.value;n<t;n++){let s=Math.floor(n/N),e=n%N,o=ot+st*e,a=it+et*s;c[n]=new mt(kt*Ht,o,a)}V.push(new z(X,400,20,100,300,"Ziek vandaag"),new z(U,400,165,50,300,"Nieuwe zieken per dag"),new z(q,400,270,100,300,"Totaal aantal zieken")),f||(f=new I(200,315,100,15,"Snelheid:"),f.addButton(200,315,20,15,"1",R.SPEED1,!1,!1),f.addButton(220,315,20,15,"2",R.SPEED2,!1,!1),f.addButton(240,315,20,15,"3",R.SPEED3,!0,!1),f.addButton(260,315,20,15,"4",R.SPEED4,!1,!1),f.addButton(280,315,20,15,"5",R.SPEED5,!1,!1),D=new I(200,345,100,15,"Simulatie:"),D.addButton(200,345,50,15,"Start",$.RUN,!1,!0),D.addButton(250,345,50,15,"Stop",$.STOP,!0,!0),C=new I(200,390,100,15,"Simulatie Reset"),ct=C.addButton(-100,-100,1,1,"Normal",L.NORMAL,!0,!1),C.addButton(300,375,60,15,"Reset",L.RESTART,!1,!1))}function Kt(){let n=0;for(;n<S.value;){let t=Math.floor(Math.random()*T.value),s=c[t],e=s.size,o=Math.floor(Math.random()*e);s.people[o].state==m.HEALTHY&&(n++,s.people[o].state=m.SICK)}}pt();})();
